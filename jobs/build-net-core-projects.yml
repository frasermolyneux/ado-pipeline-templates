parameters:
- name: jobName
  type: string
  default: 'BuildNetCoreProjects'
- name: buildConfiguration
  type: string
  default: 'Release'
- name: projects
  type: string
  default: '**/*.csproj'
- name: projectsTests
  type: string
  default: '**/*.Tests.csproj'
- name: nugetConfigPath
  type: string
  default: ''
- name: dotnetSdkVersion
  type: string
  default: '6.x'
  
jobs:
- job: ${{ parameters.jobName }}

  steps:
  - task: UseDotNet@2
    displayName: 'Use .NET SDK ${{ parameters.dotnetSdkVersion }}'
    inputs:
      version: ${{ parameters.dotnetSdkVersion }}

  - task: DotNetCoreCLI@2
    displayName: 'Restore project dependencies'
    inputs:
      command: 'restore'
      projects: ${{ parameters.projects }}

  - task: DotNetCoreCLI@2
    displayName: 'Build the projects - ${{ parameters.projects }} - ${{ parameters.buildConfiguration }}'
    inputs:
      command: 'build'
      arguments: '--no-restore --configuration ${{ parameters.buildConfiguration }}'
      projects: ${{ parameters.projects }}

  - task: DotNetCoreCLI@2
    displayName: 'Install .NET tools from local manifest'
    inputs:
      command: custom
      custom: tool
      arguments: 'restore'

  - task: DotNetCoreCLI@2
    displayName: 'Run unit tests - ${{ parameters.buildConfiguration }}'
    inputs:
      command: 'test'
      arguments: '--no-build --configuration ${{ parameters.buildConfiguration }} /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:CoverletOutput=$(Build.SourcesDirectory)/TestResults/Coverage/'
      publishTestResults: true
      projects: ${{ parameters.projectsTests }}

  - task: DotNetCoreCLI@2
    displayName: 'Create code coverage report'
    inputs:
      command: custom
      custom: tool
      arguments: 'run reportgenerator -reports:$(Build.SourcesDirectory)/**/coverage.cobertura.xml -targetdir:$(Build.SourcesDirectory)/CodeCoverage -reporttypes:HtmlInline_AzurePipelines'

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish code coverage report'
    inputs:
      codeCoverageTool: 'cobertura'
      summaryFileLocation: '$(Build.SourcesDirectory)/**/coverage.cobertura.xml'
